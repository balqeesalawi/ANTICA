{% extends 'base.html' %}

{% block content %}

<div class="detail-page">
    <p id="demo" class="hidden"></p>

    <h1 class="auction-title">{{ auction.name }}</h1>
    <h2 id="countdown" class="auction-countdown">Auction Ends In: Loading...</h2>

    <p class="auction-seller"><b>Seller:</b> {{ auction.user.username }}</p>

    <div class="auction-main">
        {% load static %}
        <img
            src="{% static auction.image|cut:'main/static/' %}"
            alt="Auction Image"
            class="auction-image"
        />

        <div class="auction-details">
            <p class="auction-description"><b>Description:</b> {{ auction.description }}</p>
            <p class="auction-starting-price"><b>Starting Price:</b> {{ auction.starting_price }} BHD</p>
            <p class="auction-latest-bid">
                <b>Latest Bid:</b> <span id="currentBid">{{ auction.current_price }}</span> BHD
            </p>
            <p class="auction-category"><b>Category:</b> {{ auction.category }}</p>

            {% if auction.user != request.user %}
                {% if auction.is_active %}
                    {% if error_message %}
                        <p class="auction-error">{{ error_message }}</p>
                    {% endif %}

                     <form action="{% url 'bids_create' auction.id %}" method="post" class="auction-bid-form">
            {% csrf_token %}
            <input type="number" name="amount" placeholder="Enter bid" class="auction-input" />
            <button type="submit" class="auction-button">Place Bid</button>
        </form>
                {% else %}
                    {% if winner == request.user %}
                        <p class="auction-winner-message">You Are The Winner of this Auction!</p>
                    {% else %}
                        {% if message %}
                            <p class="auction-message">{{ message }}</p>
                        {% endif %}
                    {% endif %}
                    <button class="auction-button-disabled" disabled>Auction Ended</button>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if auction.user == request.user %}
        {% if message %}
            <p class="auction-message">{{ message }}</p>
        {% endif %}
        <a href="{% url 'auctions_delete' auction.id %}" class="auction-delete-link">Delete</a>
    {% endif %}
</div>

<script>
    const auctionId = "{{ auction.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const auctionSocket = new WebSocket(`ws://127.0.0.1:8000/ws/auction/${auctionId}/`);

    auctionSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const currentBidEl = document.getElementById("currentBid");
        currentBidEl.textContent = data.bid;
    };

    auctionSocket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly');
    };

    const endTime = new Date("{{ auction.date|date:'c' }}").getTime();
    const countdownEl = document.getElementById('countdown');

    function updateCountdown() {
        const now = new Date().getTime();
        const diff = endTime - now;

        if (diff <= 0) {
            countdownEl.textContent = "Auction Finished!";
            const bidBtn = document.querySelector('.auction-button');
            if (bidBtn) bidBtn.disabled = true;
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();
</script>

{% endblock %}
